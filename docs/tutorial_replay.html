<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../favicon.ico">

    <title>UoService</title>

    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/tmp.css" rel="stylesheet">

    <script src="js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
  </head>

  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="https://github.com/kimbring2/uoservice">GitHub</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home<span class="sr-only">(current)</span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="states_actions.html">States/Actions<span class="sr-only"></span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="tutorial_basic.html">Basic Tutorial<span class="sr-only"></span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="tutorial_replay.html">Replay Tutorial<span class="sr-only"></span></a>
            </li>
        </ul>
      </div>
    </nav>
    
<main role="main" class="container-fluid">
    <div class="starter-template">
        <h1>Replay tutorial</h1>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <h2>MPQ (MoPaQ) archive format</h2>
                When the action is complex like Ultima Online, it is necessary to record the game play of human experts and use it for training the AI agent. In a real-time game, the amount of data generated at each second is excessively large. To solve such a problem, UoService used the same method used by Blizzard to store replay data of Starcraft game. 

                The code for the MQP is already open-sourced for the <a href="https://github.com/robpaveza/stormlibsharp">C#</a> and <a href="https://github.com/eagleflo/mpyq">Python</a>. Therefore, they could be applied into UoService easily.
            </div>

            <div class="col">
                <h5>Figure1: Replay File.</h5>
                <img src="Fig/ReplayFile.png" class="rounded mx-auto d-block" alt="Training process" width="500" height="40" align="left">
            </div>

            <div class="col">
                <hr>
                <h5>Code 1: Read the data from MPQ file.</h5>
                <pre class="pre"><code class="python">
from mpyq import MPQArchive

archive = MPQArchive("kimbring2-2023-6-29-17-35-47.uoreplay")

## The length byte array for data array
playerObjectArrayLengthArr = archive.read_file("replay.metadata.playerObjectLen");
worldItemArrayLengthArr = archive.read_file("replay.metadata.worldItemLen");
worldMobileArrayLengthArr = archive.read_file("replay.metadata.worldMobileLen");
popupMenuArrayLengthArr = archive.read_file("replay.metadata.popupMenuLen");
clilocDataArrayLengthArr = archive.read_file("replay.metadata.clilocDataLen");
playerStatusArrayLengthArr = archive.read_file("replay.metadata.playerStatusLen");
playerSkillListArrayLengthArr = archive.read_file("replay.metadata.playerSkillListLen");
staticObjectInfoListLengthArr = archive.read_file("replay.metadata.staticObjectInfoListArraysLen");

## The actual data as byte array
playerObjectArr = archive.read_file("replay.data.playerObject");
worldItemArr = archive.read_file("replay.data.worldItems");
worldMobileArr = archive.read_file("replay.data.worldMobiles");
popupMenuArr = archive.read_file("replay.data.popupMenu");
clilocDataArr = archive.read_file("replay.data.clilocData");
playerStatusArr = archive.read_file("replay.data.playerStatus");
playerSkillListArr = archive.read_file("replay.data.playerSkillList");
staticObjectInfoListArr = archive.read_file("replay.data.staticObjectInfoList");

actionTypeArr = archive.read_file("replay.action.type");
walkDirectionArr = archive.read_file("replay.action.walkDirection");
mobileSerialArr = archive.read_file("replay.action.mobileSerial");
itemSerialArr = archive.read_file("replay.action.itemSerial");
indexArr = archive.read_file("replay.action.index");
amountArr = archive.read_file("replay.action.amount");
runArr = archive.read_file("replay.action.run");
                </code></pre>
            </div>

            <div class="col">
                <h5>Code 2: Parse the data from MPQ file.</h5>
                <pre class="pre"><code class="python">
from mpyq import MPQArchive

archive = MPQArchive("kimbring2-2023-6-29-17-35-47.uoreplay")

## The length byte array for data array
playerObjectArrayLengthArr = archive.read_file("replay.metadata.playerObjectLen");
worldItemArrayLengthArr = archive.read_file("replay.metadata.worldItemLen");
worldMobileArrayLengthArr = archive.read_file("replay.metadata.worldMobileLen");
popupMenuArrayLengthArr = archive.read_file("replay.metadata.popupMenuLen");
clilocDataArrayLengthArr = archive.read_file("replay.metadata.clilocDataLen");
playerStatusArrayLengthArr = archive.read_file("replay.metadata.playerStatusLen");
playerSkillListArrayLengthArr = archive.read_file("replay.metadata.playerSkillListLen");
staticObjectInfoListLengthArr = archive.read_file("replay.metadata.staticObjectInfoListArraysLen");

## The actual data as byte array
playerObjectArr = archive.read_file("replay.data.playerObject");
worldItemArr = archive.read_file("replay.data.worldItems");
worldMobileArr = archive.read_file("replay.data.worldMobiles");
popupMenuArr = archive.read_file("replay.data.popupMenu");
clilocDataArr = archive.read_file("replay.data.clilocData");
playerStatusArr = archive.read_file("replay.data.playerStatus");
playerSkillListArr = archive.read_file("replay.data.playerSkillList");
staticObjectInfoListArr = archive.read_file("replay.data.staticObjectInfoList");

actionTypeArr = archive.read_file("replay.action.type");
walkDirectionArr = archive.read_file("replay.action.walkDirection");
mobileSerialArr = archive.read_file("replay.action.mobileSerial");
itemSerialArr = archive.read_file("replay.action.itemSerial");
indexArr = archive.read_file("replay.action.index");
amountArr = archive.read_file("replay.action.amount");
runArr = archive.read_file("replay.action.run");
                </code></pre>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <h5>Figure2: Server export templates.</h5>
                <img src="Fig/ServerTemplates.png" class="rounded mx-auto d-block float-center" alt="Training process" width=80%>
            </div>
            <div class="col">
                <h2>Server export</h2>
                When one debugs the environment, there's usually no need for rendering during the training. Using server export presets can 
                speed up the execution of the environment. When the installation script runs, it also compiles this preset, so you only need
                to export the project using them.<br><br><br><br>
            </div>
            <div class="col">
            </div>
        </div>

        <div class="row">
            <div class="col">
            </div>
            <div class="col">
                <h2>Parallelization in Python</h2>
                For some algorithms, like PPO we can use one policy to get multiple samples of the environment. In this case 
                it's useful to do it in parallel. There are two options: implementing parallelism in the engine, by spawning 
                several copies of the environment scene or launching several godot processes from python. However, we haven't yet
                tested it: you might encounter the problem with semaphore or shared memory handle naming problem. In particular when 
                multiple processes use the same shared memory and semaphores.<br><br><br><br>
            </div>
            <div class="col">
            </div>
        </div>
        
    </div><!-- /.container -->
</main>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/popper.min.js"></script>
<script src="https://getbootstrap.com/docs/4.1/dist/js/bootstrap.min.js"></script>
</body>
</html>