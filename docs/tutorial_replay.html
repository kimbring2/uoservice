<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../../../favicon.ico">

    <title>UoService</title>

    <!-- Bootstrap core CSS -->
    <link href="https://getbootstrap.com/docs/4.1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/tmp.css" rel="stylesheet">

    <script src="js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
  </head>

  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="https://github.com/kimbring2/uoservice">GitHub</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home<span class="sr-only">(current)</span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="states_actions.html">States/Actions<span class="sr-only"></span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="tutorial_basic.html">Basic Tutorial<span class="sr-only"></span></a>
            </li>

            <li class="nav-item active">
              <a class="nav-link" href="tutorial_replay.html">Replay Tutorial<span class="sr-only"></span></a>
            </li>
        </ul>
      </div>
    </nav>
    
<main role="main" class="container-fluid">
    <div class="starter-template">
        <h1>Replay tutorial</h1>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <h2>MPQ (MoPaQ) archive format</h2>
                When the action is complex like Ultima Online, it is necessary to record the game play of human experts and use it for training the AI agent. In a real-time game, the amount of data generated at each second is excessively large. To solve such a problem, UoService used the same method used by Blizzard to store replay data of Starcraft game. 

                The code for the MQP is already open-sourced for the <a href="https://github.com/robpaveza/stormlibsharp">C#</a> and <a href="https://github.com/eagleflo/mpyq">Python</a>. Therefore, they could be applied into UoService easily. 
            </div>

            <div class="col">
                <h5>Figure1: Replay File.</h5>
                <img src="Fig/ReplayFile.png" class="rounded mx-auto d-block" alt="Training process" width="500" height="40" align="left">
            </div>

            <div class="row">
                <div class="col">
                    <hr>
                    <h2>Replay file composition </h2>
                    
                    Because game information does not always change, it is inefficient to store state data of every game tick. For example,if there will be no need to receive GrpcPlayerObject data if the player does not move. Of course, this method requires another array to store the length of the data. However, this method has an advantage than saving the main data array because a single int value is enough to store the length. 
                </div>

                <div class="col">
                    <hr>
                    <h5>Figure2: Replay File Composition.</h5>
                    <img src="Fig/ReplayComposition.png" class="rounded mx-auto d-block float-center" alt="Training process" width=80%>
                </div>
            </div>

            <div class="col">
                <hr>
                <h5>Code 1: Read the data from MPQ file.</h5>
                <pre class="pre"><code class="python">
from mpyq import MPQArchive

archive = MPQArchive("kimbring2-2023-6-29-17-35-47.uoreplay")

## The length byte array for data array
playerObjectArrayLengthArr = archive.read_file("replay.metadata.playerObjectLen");
worldItemArrayLengthArr = archive.read_file("replay.metadata.worldItemLen");
worldMobileArrayLengthArr = archive.read_file("replay.metadata.worldMobileLen");
popupMenuArrayLengthArr = archive.read_file("replay.metadata.popupMenuLen");
clilocDataArrayLengthArr = archive.read_file("replay.metadata.clilocDataLen");
playerStatusArrayLengthArr = archive.read_file("replay.metadata.playerStatusLen");
playerSkillListArrayLengthArr = archive.read_file("replay.metadata.playerSkillListLen");
staticObjectInfoListLengthArr = archive.read_file("replay.metadata.staticObjectInfoListArraysLen");
actionArrayLengthArr = archive.read_file("replay.metadata.actionArraysLen");

## The actual data as byte array
playerObjectArr = archive.read_file("replay.data.playerObject");
worldItemArr = archive.read_file("replay.data.worldItems");
worldMobileArr = archive.read_file("replay.data.worldMobiles");
popupMenuArr = archive.read_file("replay.data.popupMenu");
clilocDataArr = archive.read_file("replay.data.clilocData");
playerStatusArr = archive.read_file("replay.data.playerStatus");
playerSkillListArr = archive.read_file("replay.data.playerSkillList");
staticObjectInfoListArr = archive.read_file("replay.data.staticObjectInfoList");
actionArr = archive.read_file("replay.data.actionArrays");
                </code></pre>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <hr>
                <h5>Code 2: Parse the main data using length array.</h5>
                <pre class="pre"><code class="python">
_playerObjectArrayOffset = 0
_playerObjectList = []

def GetSubsetArray(index, lengthList, offset, arr):
    # Crop the part of array when the length is variable. Return the modifed offset value for next cropping.
    item = lengthList[index]
    startIndex = offset
    subsetArray = arr[startIndex:startIndex + item]
    offset += item

    return subsetArray, offset

playerObjectSubsetArray, _playerObjectArrayOffset = GetSubsetArray(step, playerObjectArrayLengthList, 
                                                                   _playerObjectArrayOffset, 
                                                                   self.playerObjectArr)
grpcPlayerObjectReplay = UoService_pb2.GrpcPlayerObject().FromString(playerObjectSubsetArray)
_playerObjectList.append(grpcPlayerObjectReplay)
                </code></pre>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <hr>
                <h5>Code 3: Obtain the player object information from replay data.</h5>
                <pre class="pre"><code class="python">
if _playerObjectList[replay_step].gameX != 0:
    player_game_x = _playerObjectList[replay_step].gameX
    player_game_y = _playerObjectList[replay_step].gameY



                </code></pre>
            </div>
        </div>
        
    </div><!-- /.container -->
</main>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/popper.min.js"></script>
<script src="https://getbootstrap.com/docs/4.1/dist/js/bootstrap.min.js"></script>
</body>
</html>